{"version":3,"file":"../../actions/AttackAction.js","sourceRoot":"../../../src","sources":["actions/AttackAction.coffee"],"names":[],"mappings":"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","sourcesContent":["WalkAction = require('./WalkAction')\nTargetAction = require('./TargetAction')\nEventBind = require('spark-starter').EventBind\nPropertyWatcher = require('spark-starter').Invalidated.PropertyWatcher\n\nmodule.exports = class AttackAction extends TargetAction\n  @properties\n    walkAction:\n      calcul: ->\n        walkAction = new WalkAction(actor: @actor, target: @target, parent: @parent)\n        walkAction.pathFinder.arrivedCallback = (step) =>\n          @canUseWeaponAt(step.tile)\n        walkAction\n    bestUsableWeapon:\n      calcul: (invalidator)->\n        invalidator.propPath('actor.tile')\n        if @actor.weapons?.length\n          usableWeapons = @actor.weapons.filter (weapon)=>\n            weapon.canUseOn(@target)\n          usableWeapons.sort (a, b)=>\n            return b.dps - a.dps\n          usableWeapons[0]\n        else\n          null\n    interruptBinder:\n      calcul: ->\n        new EventBind 'interrupted', null, =>\n          @interrupt()\n      destroy: true\n    weaponChargeWatcher:\n      calcul: ->\n        new PropertyWatcher({\n          callback: ()=>\n            if @bestUsableWeapon.charged\n              @useWeapon()\n          property: @bestUsableWeapon.getPropertyInstance('charged')\n        })\n      destroy: true\n\n  validTarget: ()->\n    @targetIsAttackable() and (@canUseWeapon() or @canWalkToTarget())\n  targetIsAttackable: ()->\n    @target.damageable and @target.health >=0\n  canMelee: ->\n    Math.abs(@target.tile.x - @actor.tile.x) + Math.abs(@target.tile.y - @actor.tile.y) == 1\n  canUseWeapon: ->\n    @bestUsableWeapon?\n  canUseWeaponAt: (tile)->\n    @actor.weapons?.length and @actor.weapons.find (weapon)=>\n      weapon.canUseFrom(tile, @target)\n  canWalkToTarget: ->\n    @walkAction.isReady()\n\n  useWeapon: ->\n    @bestUsableWeapon.useOn(@target)\n    @finish()\n\n  execute: ->\n    if @actor.walk?\n      @actor.walk.interrupt()\n    if @bestUsableWeapon?\n      if @bestUsableWeapon.charged\n        @useWeapon()\n      else\n        @weaponChargeWatcher.bind()\n    else\n      @walkAction.on 'finished', =>\n        @interruptBinder.unbind()\n        if @isReady()\n          @start()\n      @interruptBinder.bindTo(@walkAction)\n      @walkAction.execute()"]}