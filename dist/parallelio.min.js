(function(){var t,e,i,n,r,o,s,u,h,l,a,p,c,f=[].slice,y=function(t,e){function i(){this.constructor=t}for(var n in e)d.call(e,n)&&(t[n]=e[n]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},d={}.hasOwnProperty,g=[].indexOf||function(t){for(var e=0,i=this.length;e<i;e++)if(e in this&&this[e]===t)return e;return-1};void 0!==r&&null!==r||(r={}),void 0!==h&&null!==h||(h={}),i=function(){function t(t,e,i){this.event=t,this.target=e,this.callback=i,this.binded=!1}return t.prototype.bind=function(){return this.binded||this.target.addListener(this.event,this.callback),this.binded=!0},t.prototype.unbind=function(){return this.binded&&this.target.removeListener(this.event,this.callback),this.binded=!1},t.prototype.equals=function(t){return t.event===this.event&&t.target===this.target&&t.callback===this.callback},t}(),null!=h&&(h.EventBind=i),c=function(t,e){var i,n;return n=t.findIndex(e),n>-1?(i=t[n],t.splice(n,1),i):null},n=function(){function t(t,e){this.property=t,this.obj=null!=e?e:null,this.invalidationEvents=[],this.recycled=[],this.invalidateCallback=function(t){return function(){return t.invalidate(),null}}(this)}return t.prototype.invalidate=function(){var t;return"function"==typeof this.property.invalidate?this.property.invalidate():(t="invalidate"+this.property.charAt(0).toUpperCase()+this.property.slice(1),"function"==typeof this.obj[t]?this.obj[t]():this.obj[this.property]=null)},t.prototype.event=function(t,e){if(null==e&&(e=this.obj),!this.invalidationEvents.some(function(i){return i.event===t&&i.target===e}))return this.invalidationEvents.push(c(this.recycled,function(i){return i.event===t&&i.target===e})||new i(t,e,this.invalidateCallback))},t.prototype.value=function(t,e,i){return null==i&&(i=this.obj),this.event(e,i),t},t.prototype.prop=function(t,e){return null==e&&(e=this.obj),this.value(e[t],t+"Changed",e)},t.prototype.isEmpty=function(){return 0===this.invalidationEvents.length},t.prototype.bind=function(){return this.invalidationEvents.forEach(function(t){return t.bind()})},t.prototype.recycle=function(t){var e,i;return this.recycled=this.invalidationEvents,this.invalidationEvents=[],e=function(t){return function(){return t.recycled.forEach(function(t){return t.unbind()}),t.recycled=[]}}(this),"function"==typeof t?t.length>1?t(this,e):(i=t(this),e(),i):e},t.prototype.unbind=function(){return this.invalidationEvents.forEach(function(t){return t.unbind()})},t}(),null!=h&&(h.Invalidator=n),t=function(){function t(t){null!=t?"function"==typeof t.toArray?this._array=t.toArray():Array.isArray(t)?this._array=t:this._array=[t]:this._array=[]}return t.prototype.changed=function(){},t.prototype.get=function(t){return this._array[t]},t.prototype.set=function(t,e){var i;return this._array[t]!==e&&(i=this.toArray(),this._array[t]=e,this.changed(i)),e},t.prototype.add=function(t){if(!this._array.includes(t))return this.push(t)},t.prototype.remove=function(t){var e,i;if(-1!==(e=this._array.indexOf(t)))return i=this.toArray(),this._array.splice(e,1),this.changed(i)},t.prototype.toArray=function(){return this._array.slice()},t.prototype.count=function(){return this._array.length},t.readFunctions=["every","find","findIndex","forEach","includes","indexOf","join","lastIndexOf","map","reduce","reduceRight","some","toString"],t.readListFunctions=["concat","filter","slice"],t.writefunctions=["pop","push","reverse","shift","sort","splice","unshift"],t.readFunctions.forEach(function(e){return t.prototype[e]=function(){var t,i;return t=1<=arguments.length?f.call(arguments,0):[],(i=this._array)[e].apply(i,t)}}),t.readListFunctions.forEach(function(e){return t.prototype[e]=function(){var t,i;return t=1<=arguments.length?f.call(arguments,0):[],this.copy((i=this._array)[e].apply(i,t))}}),t.writefunctions.forEach(function(e){return t.prototype[e]=function(){var t,i,n,r;return t=1<=arguments.length?f.call(arguments,0):[],i=this.toArray(),r=(n=this._array)[e].apply(n,t),this.changed(i),r}}),t.newSubClass=function(t,e){var i;return"object"==typeof t?(i=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return y(e,t),e}(this),Object.assign(i.prototype,t),new i(e)):new this(e)},t.prototype.copy=function(t){return null==t&&(t=this.toArray()),new this.constructor(t)},t.prototype.equals=function(t){return this.count()===(tyepeof("function"===t.count)?t.count():t.length)&&this.every(function(e,i){return t[i]===e})},t.prototype.getAddedFrom=function(t){return this._array.filter(function(e){return!t.includes(e)})},t.prototype.getRemovedFrom=function(t){return t.filter(function(t){return function(e){return!t.includes(e)}}(this))},t}(),null!=h&&(h.Collection=t),u=function(){function e(t,e){this.property=t,this.obj=e,this.value=this.ingest(this.property.options.default),this.calculated=!1}return e.prototype.get=function(){return!1===this.property.options.get?void 0:"function"==typeof this.property.options.get?this.callOptionFunct("get"):(this.calculated||this.calcul(),this.output())},e.prototype.set=function(t){var e;return!1===this.property.options.set||("function"==typeof this.property.options.set?this.callOptionFunct("set",t):(t=this.ingest(t),this.value!==t&&(e=this.value,this.value=t,this.changed(e)))),this},e.prototype.invalidate=function(){var t;if(this.calculated)if(this.calculated=!1,this.isImmediate()){if(t=this.value,this.get(),this.value!==t)return this.changed(t)}else if(null!=this.invalidator)return this.invalidator.unbind()},e.prototype.destroy=function(){if(null!=this.invalidator)return this.invalidator.unbind()},e.prototype.callOptionFunct=function(){var t,e;return e=arguments[0],t=2<=arguments.length?f.call(arguments,1):[],"string"==typeof e&&(e=this.property.options[e]),"function"==typeof e.overrided&&t.push(function(t){return function(){var i;return i=1<=arguments.length?f.call(arguments,0):[],t.callOptionFunct.apply(t,[e.overrided].concat(f.call(i)))}}(this)),e.apply(this.obj,t)},e.prototype.calcul=function(){return"function"==typeof this.property.options.calcul&&(this.invalidator||(this.invalidator=new n(this,this.obj)),this.invalidator.recycle(function(t){return function(e){return t.value=t.callOptionFunct("calcul",e),e.isEmpty()?t.invalidator=null:e.bind()}}(this))),this.calculated=!0,this.value},e.prototype.isACollection=function(t){return null!=this.property.options.collection},e.prototype.ingest=function(t){return"function"==typeof this.property.options.ingest?t=this.callOptionFunct("ingest",t):this.isACollection()?null==t?[]:"function"==typeof t.toArray?t.toArray():Array.isArray(t)?t.slice():[t]:t},e.prototype.output=function(){var e,i;return"function"==typeof this.property.options.output?this.callOptionFunct("output",this.value):this.isACollection()?(i=this,e=t.newSubClass(this.property.options.collection,this.value),e.changed=function(t){return i.changed(t)},e):this.value},e.prototype.changed=function(t){if("function"==typeof this.property.options.change&&this.callOptionFunct("change",t),"function"==typeof this.obj.emitEvent)return this.obj.emitEvent(this.property.getChangeEventName(),[t])},e.prototype.isImmediate=function(){return!1!==this.property.options.immediate&&(!0===this.property.options.immediate||"function"==typeof this.obj.getListeners&&this.obj.getListeners(this.property.getChangeEventName()).length>0||"function"==typeof this.property.options.change)},e}(),null!=h&&(h.PropertyInstance=u),s=function(){function t(t,e){this.name=t,this.options=null!=e?e:{}}return t.prototype.bind=function(t){var e,i,n;return n=this,"function"==typeof t.getProperty&&null!=(i=t.getProperty(this.name))&&this.override(i),e=this.name.charAt(0).toUpperCase()+this.name.slice(1),Object.defineProperty(t,this.name,{configurable:!0,get:function(){return n.getInstance(this).get()},set:function(t){return n.getInstance(this).set(t)}}),t["get"+e]=function(){return n.getInstance(this).get()},t["set"+e]=function(t){return n.getInstance(this).set(t),this},t["invalidate"+e]=function(){return n.getInstance(this).invalidate(),this},t._properties=(t._properties||[]).concat([n]),null!=i&&(t._properties=t._properties.filter(function(t){return t!==i})),this.checkFunctions(t),this.checkAfterAddListener(t),n},t.prototype.override=function(t){var e,i,n,r;this.options.parent=t.options,i=t.options,n=[];for(e in i)r=i[e],"function"==typeof this.options[e]&&"function"==typeof r?n.push(this.options[e].overrided=r):void 0===this.options[e]?n.push(this.options[e]=r):n.push(void 0);return n},t.prototype.checkFunctions=function(e){var i,n,r,o;this.checkAfterAddListener(e),r=t.fn,o=[];for(n in r)i=r[n],void 0===e[n]?o.push(e[n]=i):o.push(void 0);return o},t.prototype.checkAfterAddListener=function(e){var i;if("function"==typeof e.addListener&&void 0===e.afterAddListener)return e.afterAddListener=t.optionalFn.afterAddListener,i=e.addListener,e.addListener=function(t,e){return this.addListener.overrided.call(this,t,e),this.afterAddListener(t)},e.addListener.overrided=i},t.prototype.getInstanceVarName=function(){return this.options.instanceVarName||"_"+this.name},t.prototype.isInstantiated=function(t){return null!=t[this.getInstanceVarName()]},t.prototype.getInstance=function(t){var e;return e=this.getInstanceVarName(),this.isInstantiated(t)||(t[e]=new u(this,t)),t[e]},t.prototype.getChangeEventName=function(){return this.options.changeEventName||this.name+"Changed"},t.fn={getProperty:function(t){return this._properties.find(function(e){return e.name===t})},getPropertyInstance:function(t){var e;if(e=this.getProperty(t))return e.getInstance(this)},getProperties:function(){return this._properties.slice()},getPropertyInstances:function(){return this._properties.map(function(t){return function(e){return e.getInstance(t)}}(this))},getInstantiatedProperties:function(){return this._properties.filter(function(t){return function(e){return e.isInstantiated(t)}}(this)).map(function(t){return function(e){return e.getInstance(t)}}(this))},destroyProperties:function(){return this.getInstantiatedProperties().forEach(function(t){return function(t){return t.destroy()}}()),this._properties=[],!0}},t.optionalFn={afterAddListener:function(t){return this._properties.forEach(function(e){return function(i){if(i.getChangeEventName()===t)return i.getInstance(e).get()}}(this))}},t}(),null!=h&&(h.Property=s),e=function(){function t(){}return t.elementKeywords=["extended","included"],t.prototype.tap=function(t){var e;return e=Array.prototype.slice.call(arguments),"function"==typeof t?t.apply(this,e.slice(1)):this[t].apply(this,e.slice(1)),this},t.prototype.callback=function(t){return null==this._callbacks&&(this._callbacks={}),null!=this._callbacks[t]?this._callbacks[t]:this._callbacks[t]=function(e){return function(){var i;return i=1<=arguments.length?f.call(arguments,0):[],e[t].call(e,i),null}}(this)},t.extend=function(e){var i,n,r;for(i in e)r=e[i],g.call(t.elementKeywords,i)<0&&(this[i]=r);return null!=(n=e.extended)&&n.apply(this),this},t.include=function(e){var i,n,r;for(i in e)r=e[i],g.call(t.elementKeywords,i)<0&&(this.prototype[i]=r);return null!=(n=e.included)&&n.apply(this),this},t.property=function(t,e){return new s(t,e).bind(this.prototype)},t.properties=function(t){var e,i,n;n=[];for(i in t)e=t[i],n.push(this.property(i,e));return n},t}(),null!=h&&(h.Element=e),l=function(t){function e(t,e){this.x=t,this.y=e,this.init()}return y(e,t),e.properties({x:{},y:{},links:{collection:{findStar:function(t){return this.find(function(e){return e.star2===t||e.star1===t})}}}}),e.prototype.init=function(){},e.prototype.linkTo=function(t){if(!this.links.findStar(t))return this.addLink(new e.Link(this,t))},e.prototype.addLink=function(t){return this.links.add(t),t.otherStar(this).links.add(t),t},e.prototype.dist=function(t,e){var i,n;return i=this.x-t,n=this.y-e,Math.sqrt(i*i+n*n)},e}(e),l.Link=function(t){function e(t,e){this.star1=t,this.star2=e}return y(e,t),e.prototype.remove=function(){return this.star1.links.remove(this),this.star2.links.remove(this)},e.prototype.otherStar=function(t){return t===this.star1?this.star2:this.star1},e.prototype.getLength=function(){return this.star1.dist(this.star2.x,this.star2.y)},e.prototype.inBoundaryBox=function(t,e,i){var n,r,o,s;return null==i&&(i=0),n=Math.min(this.star1.x,this.star2.x)-i,o=Math.min(this.star1.y,this.star2.y)-i,r=Math.max(this.star1.x,this.star2.x)+i,s=Math.max(this.star1.y,this.star2.y)+i,t>=n&&t<=r&&e>=o&&e<=s},e.prototype.closeToPoint=function(t,e,i){var n,r,o,s,u,h,l,a,p,c,f;return!!this.inBoundaryBox(t,e,i)&&(n=this.star1,h=this.star2,l={x:t,y:e},a=h.x-n.x,c=h.y-n.y,Math.sqrt(a*a+c*c),o=Math.atan(c/a),p=l.x-n.x,f=l.y-n.y,s=Math.sqrt(p*p+f*f),u=Math.atan(f/p),r=o-u,Math.abs(Math.sin(r)*s)<=i)},e.prototype.intersectLink=function(t){var e,i,n,r,o,s,u,h,l,a,p,c,f,y;return u=this.star1.x,p=this.star1.y,h=this.star2.x,c=this.star2.y,l=t.star1.x,f=t.star1.y,a=t.star2.x,y=t.star2.y,i=h-u,n=c-p,r=a-l,o=y-f,e=(-n*(u-l)+i*(p-f))/(-r*n+i*o),s=(r*(p-f)-o*(u-l))/(-r*n+i*o),e>0&&e<1&&s>0&&s<1},e}(e),null!=r&&(r.Star=l),null==h&&(h={}),o=function(t){function e(t,e,i,n){this.tilesContainer=t,this.from=e,this.to=i,null==n&&(n={}),this.reset(),null!=n.validTile&&(this.validTileCallback=n.validTile)}return y(e,t),e.properties({validTileCallback:{}}),e.prototype.reset=function(){return this.queue=[],this.paths={},this.solution=null,this.started=!1},e.prototype.calcul=function(){for(;!this.solution&&(!this.started||this.queue.length);)this.step();return this.getPath()},e.prototype.step=function(){var t;return this.queue.length?(t=this.queue.pop(),this.addNextSteps(t),!0):this.started?void 0:(this.started=!0,this.addNextSteps(),!0)},e.prototype.getPath=function(){var t,e;if(this.solution){for(t=[this.solution],e=this.solution;null!=e.prev;)t.unshift(e.prev),e=e.prev;return t}},e.prototype.getPosAtTime=function(t){var e,i;if(this.solution){if(t>=this.solution.getTotalLength())return this.solution.posToTileOffset(this.solution.getExit().x,this.solution.getExit().y);for(i=this.solution;i.getStartLength()>t&&null!=i.prev;)i=i.prev;return e=(t-i.getStartLength())/i.getLength(),i.posToTileOffset(i.getEntry().x+(i.getExit().x-i.getEntry().x)*e,i.getEntry().y+(i.getExit().y-i.getEntry().y)*e)}},e.prototype.tileIsValid=function(t){return null!=this.validTileCallback?this.validTileCallback(t):!t.emulated||0!==t.tile&&!1!==t.tile},e.prototype.getTile=function(t,e){var i;return null!=this.tilesContainer.getTile?this.tilesContainer.getTile(t,e):null!=(null!=(i=this.tilesContainer[e])?i[t]:void 0)?{x:t,y:e,tile:this.tilesContainer[e][t],emulated:!0}:void 0},e.prototype.getConnectedToTile=function(t){var e,i;return null!=t.getConnected?t.getConnected():(e=[],(i=this.getTile(t.x+1,t.y))&&e.push(i),(i=this.getTile(t.x-1,t.y))&&e.push(i),(i=this.getTile(t.x,t.y+1))&&e.push(i),(i=this.getTile(t.x,t.y-1))&&e.push(i),e)},e.prototype.addNextSteps=function(t){var i,n,r,o,s,u;for(null==t&&(t=null),u=null!=t?t.nextTile:this.from,o=this.getConnectedToTile(u),s=[],i=0,n=o.length;i<n;i++)r=o[i],this.tileIsValid(r)?s.push(this.addStep(new e.Step(this,null!=t?t:null,u,r))):s.push(void 0);return s},e.prototype.tileEqual=function(t,e){return t===e||(t.emulated||e.emulated)&&t.x===e.x&&t.y===e.y},e.prototype.addStep=function(t){if(null==this.paths[t.getExit().x]&&(this.paths[t.getExit().x]={}),!(null!=this.paths[t.getExit().x][t.getExit().y]&&this.paths[t.getExit().x][t.getExit().y].getTotalLength()<=t.getTotalLength())&&(null!=this.paths[t.getExit().x][t.getExit().y]&&this.removeStep(this.paths[t.getExit().x][t.getExit().y]),this.paths[t.getExit().x][t.getExit().y]=t,this.queue.splice(this.getStepRank(t),0,t),this.tileEqual(t.nextTile,this.to)&&!(null!=this.solution&&this.solution.prev.getTotalLength()<=t.getTotalLength())))return this.solution=new e.Step(this,t,t.nextTile,null)},e.prototype.removeStep=function(t){var e;if((e=this.queue.indexOf(t))>-1)return this.queue.splice(e,1)},e.prototype.best=function(){return this.queue[this.queue.length-1]},e.prototype.getStepRank=function(t){return 0===this.queue.length?0:this._getStepRank(t.getEfficiency(),0,this.queue.length-1)},e.prototype._getStepRank=function(t,e,i){var n,r;return r=Math.floor((i-e)/2)+e,n=this.queue[r].getEfficiency(),n===t?r:n>t?r===e?e:this._getStepRank(t,e,r-1):r===i?i+1:this._getStepRank(t,r+1,i)},e}(e),o.Step=function(){function t(t,e,i,n){this.pathFinder=t,this.prev=e,this.tile=i,this.nextTile=n}return t.prototype.posToTileOffset=function(t,e){var i;return i=Math.floor(t)===this.tile.x&&Math.floor(e)===this.tile.y?this.tile:Math.floor(t)===this.nextTile.x&&Math.floor(e)===this.nextTile.y?this.nextTile:null!=this.prev&&Math.floor(t)===this.prev.tile.x&&Math.floor(e)===this.prev.tile.y?this.prev.tile:console.log("Math.floor("+t+") == "+this.tile.x,"Math.floor("+e+") == "+this.tile.y,this),{x:t,y:e,tile:i,offsetX:t-i.x,offsetY:e-i.y}},t.prototype.getExit=function(){return null==this.exit&&(null!=this.nextTile?this.exit={x:(this.tile.x+this.nextTile.x+1)/2,y:(this.tile.y+this.nextTile.y+1)/2}:this.exit={x:this.tile.x+.5,y:this.tile.y+.5}),this.exit},t.prototype.getEntry=function(){return null==this.entry&&(null!=this.prev?this.entry={x:(this.tile.x+this.prev.tile.x+1)/2,y:(this.tile.y+this.prev.tile.y+1)/2}:this.entry={x:this.tile.x+.5,y:this.tile.y+.5}),this.entry},t.prototype.getLength=function(){return null==this.length&&(this.length=null==this.nextTile||null==this.prev?.5:this.prev.tile.x===this.nextTile.x||this.prev.tile.y===this.nextTile.y?1:Math.sqrt(.5)),this.length},t.prototype.getStartLength=function(){return null==this.startLength&&(this.startLength=null!=this.prev?this.prev.getTotalLength():0),this.startLength},t.prototype.getTotalLength=function(){return null==this.totalLength&&(this.totalLength=this.getStartLength()+this.getLength()),this.totalLength},t.prototype.getEfficiency=function(){return null==this.efficiency&&(this.efficiency=1.1*-this.getRemaining()-this.getTotalLength()),this.efficiency},t.prototype.getRemaining=function(){var t,e,i,n;return null==this.remaining&&(t=this.getExit(),e={x:this.pathFinder.to.x+.5,y:this.pathFinder.to.y+.5},i=e.x-t.x,n=e.y-t.y,this.remaining=Math.sqrt(i*i+n*n)),this.remaining},t}(),null!=r&&(r.PathFinder=o),a=function(t){function e(t,e){this.x=t,this.y=e,this.init()}return y(e,t),e.prototype.init=function(){return this.children=[]},e.prototype.getRelativeTile=function(t,e){return this.container.getTile(this.x+t,this.y+e)},e.prototype.addChild=function(t){var e;return e=this.children.indexOf(t),-1===e&&this.children.push(t),t.tile=this,t},e.prototype.removeChild=function(t){var e;if(e=this.children.indexOf(t),e>-1&&this.children.splice(e,1),t.tile===this)return t.tile=null},e}(e),null!=r&&(r.Tile=a),p=function(t){function e(){this.init()}return y(e,t),e.prototype.init=function(){return this.coords={},this.tiles=[]},e.prototype.addTile=function(t){return this.tiles.push(t),null==this.coords[t.x]&&(this.coords[t.x]={}),this.coords[t.x][t.y]=t,t.container=this},e.prototype.getTile=function(t,e){var i;if(null!=(null!=(i=this.coords[t])?i[e]:void 0))return this.coords[t][e]},e.prototype.loadMatrix=function(t){var e,i,n,r,o,s;i=[];for(s in t)n=t[s],i.push(function(){var t;t=[];for(o in n)r=n[o],e={x:parseInt(o),y:parseInt(s)},"function"==typeof r?t.push(this.addTile(r(e))):(r.x=e.x,r.y=e.y,t.push(this.addTile(r)));return t}.call(this));return i},e.prototype.allTiles=function(){return this.tiles.slice()},e.prototype.clearAll=function(){var t,e,i,n;for(i=this.tiles,t=0,e=i.length;t<e;t++)n=i[t],n.container=null;return this.coords={},this.tiles=[]},e}(e),null!=r&&(r.TileContainer=p),r.Element=h.Element,"undefined"!=typeof module&&null!==module?module.exports=r:this.Parallelio=r,"undefined"!=typeof module&&null!==module?module.exports=h:this.Spark=h}).call(this);