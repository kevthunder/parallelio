(function(){var t,n,i,e,r,o,s,u,h,l,a,p,c,f=[].slice,y=function(t,n){function i(){this.constructor=t}for(var e in n)d.call(n,e)&&(t[e]=n[e]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},d={}.hasOwnProperty,g=[].indexOf||function(t){for(var n=0,i=this.length;n<i;n++)if(n in this&&this[n]===t)return n;return-1};void 0!==r&&null!==r||(r={}),void 0!==h&&null!==h||(h={}),i=function(){function t(t,n,i){this.event=t,this.target=n,this.callback=i,this.binded=!1}return t.prototype.bind=function(){return this.binded||this.target.addListener(this.event,this.callback),this.binded=!0},t.prototype.unbind=function(){return this.binded&&this.target.removeListener(this.event,this.callback),this.binded=!1},t.prototype.equals=function(t){return t.event===this.event&&t.target===this.target&&t.callback===this.callback},t}(),null!=h&&(h.EventBind=i),c=function(t,n){var i,e;return e=t.findIndex(n),e>-1?(i=t[e],t.splice(e,1),i):null},e=function(){function t(t,n){this.property=t,this.obj=null!=n?n:null,this.invalidationEvents=[],this.recycled=[],this.invalidateCallback=function(t){return function(){return t.invalidate(),null}}(this)}return t.prototype.invalidate=function(){var t;return"function"==typeof this.property.invalidate?this.property.invalidate():(t="invalidate"+this.property.charAt(0).toUpperCase()+this.property.slice(1),"function"==typeof this.obj[t]?this.obj[t]():this.obj[this.property]=null)},t.prototype.event=function(t,n){if(null==n&&(n=this.obj),!this.invalidationEvents.some(function(i){return i.event===t&&i.target===n}))return this.invalidationEvents.push(c(this.recycled,function(i){return i.event===t&&i.target===n})||new i(t,n,this.invalidateCallback))},t.prototype.value=function(t,n,i){return null==i&&(i=this.obj),this.event(n,i),t},t.prototype.prop=function(t,n){return null==n&&(n=this.obj),this.value(n[t],t+"Changed",n)},t.prototype.isEmpty=function(){return 0===this.invalidationEvents.length},t.prototype.bind=function(){return this.invalidationEvents.forEach(function(t){return t.bind()})},t.prototype.recycle=function(t){var n,i;return this.recycled=this.invalidationEvents,this.invalidationEvents=[],n=function(t){return function(){return t.recycled.forEach(function(t){return t.unbind()}),t.recycled=[]}}(this),"function"==typeof t?t.length>1?t(this,n):(i=t(this),n(),i):n},t.prototype.unbind=function(){return this.invalidationEvents.forEach(function(t){return t.unbind()})},t}(),null!=h&&(h.Invalidator=e),t=function(){function t(t){null!=t?"function"==typeof t.toArray?this._array=t.toArray():Array.isArray(t)?this._array=t:this._array=[t]:this._array=[]}return t.prototype.changed=function(){},t.prototype.get=function(t){return this._array[t]},t.prototype.set=function(t,n){var i;return this._array[t]!==n&&(i=this.toArray(),this._array[t]=n,this.changed(i)),n},t.prototype.add=function(t){if(!this._array.includes(t))return this.push(t)},t.prototype.remove=function(t){var n,i;if(-1!==(n=this._array.indexOf(t)))return i=this.toArray(),this._array.splice(n,1),this.changed(i)},t.prototype.toArray=function(){return this._array.slice()},t.prototype.count=function(){return this._array.length},t.readFunctions=["every","find","findIndex","forEach","includes","indexOf","join","lastIndexOf","map","reduce","reduceRight","some","toString"],t.readListFunctions=["concat","filter","slice"],t.writefunctions=["pop","push","reverse","shift","sort","splice","unshift"],t.readFunctions.forEach(function(n){return t.prototype[n]=function(){var t,i;return t=1<=arguments.length?f.call(arguments,0):[],(i=this._array)[n].apply(i,t)}}),t.readListFunctions.forEach(function(n){return t.prototype[n]=function(){var t,i;return t=1<=arguments.length?f.call(arguments,0):[],this.copy((i=this._array)[n].apply(i,t))}}),t.writefunctions.forEach(function(n){return t.prototype[n]=function(){var t,i,e,r;return t=1<=arguments.length?f.call(arguments,0):[],i=this.toArray(),r=(e=this._array)[n].apply(e,t),this.changed(i),r}}),t.newSubClass=function(t,n){var i;return"object"==typeof t?(i=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return y(n,t),n}(this),Object.assign(i.prototype,t),new i(n)):new this(n)},t.prototype.copy=function(t){return null==t&&(t=this.toArray()),new this.constructor(t)},t.prototype.equals=function(t){return this.count()===(tyepeof("function"===t.count)?t.count():t.length)&&this.every(function(n,i){return t[i]===n})},t.prototype.getAddedFrom=function(t){return this._array.filter(function(n){return!t.includes(n)})},t.prototype.getRemovedFrom=function(t){return t.filter(function(t){return function(n){return!t.includes(n)}}(this))},t}(),null!=h&&(h.Collection=t),u=function(){function n(t,n){this.property=t,this.obj=n,this.value=this.ingest(this.property.options.default),this.calculated=!1}return n.prototype.get=function(){return!1===this.property.options.get?void 0:"function"==typeof this.property.options.get?this.callOptionFunct("get"):(this.calculated||this.calcul(),this.output())},n.prototype.set=function(t){var n;return!1===this.property.options.set||("function"==typeof this.property.options.set?this.callOptionFunct("set",t):(t=this.ingest(t),this.value!==t&&(n=this.value,this.value=t,this.changed(n)))),this},n.prototype.invalidate=function(){var t;if(this.calculated)if(this.calculated=!1,this.isImmediate()){if(t=this.value,this.get(),this.value!==t)return this.changed(t)}else if(null!=this.invalidator)return this.invalidator.unbind()},n.prototype.destroy=function(){if(null!=this.invalidator)return this.invalidator.unbind()},n.prototype.callOptionFunct=function(){var t,n;return n=arguments[0],t=2<=arguments.length?f.call(arguments,1):[],"string"==typeof n&&(n=this.property.options[n]),"function"==typeof n.overrided&&t.push(function(t){return function(){var i;return i=1<=arguments.length?f.call(arguments,0):[],t.callOptionFunct.apply(t,[n.overrided].concat(f.call(i)))}}(this)),n.apply(this.obj,t)},n.prototype.calcul=function(){return"function"==typeof this.property.options.calcul&&(this.invalidator||(this.invalidator=new e(this,this.obj)),this.invalidator.recycle(function(t){return function(n){return t.value=t.callOptionFunct("calcul",n),n.isEmpty()?t.invalidator=null:n.bind()}}(this))),this.calculated=!0,this.value},n.prototype.isACollection=function(t){return null!=this.property.options.collection},n.prototype.ingest=function(t){return"function"==typeof this.property.options.ingest?t=this.callOptionFunct("ingest",t):this.isACollection()?null==t?[]:"function"==typeof t.toArray?t.toArray():Array.isArray(t)?t.slice():[t]:t},n.prototype.output=function(){var n,i;return"function"==typeof this.property.options.output?this.callOptionFunct("output",this.value):this.isACollection()?(i=this,n=t.newSubClass(this.property.options.collection,this.value),n.changed=function(t){return i.changed(t)},n):this.value},n.prototype.changed=function(t){if("function"==typeof this.property.options.change&&this.callOptionFunct("change",t),"function"==typeof this.obj.emitEvent)return this.obj.emitEvent(this.property.getChangeEventName(),[t])},n.prototype.isImmediate=function(){return!1!==this.property.options.immediate&&(!0===this.property.options.immediate||"function"==typeof this.obj.getListeners&&this.obj.getListeners(this.property.getChangeEventName()).length>0||"function"==typeof this.property.options.change)},n}(),null!=h&&(h.PropertyInstance=u),s=function(){function t(t,n){this.name=t,this.options=null!=n?n:{}}return t.prototype.bind=function(t){var n,i,e;return e=this,"function"==typeof t.getProperty&&null!=(i=t.getProperty(this.name))&&this.override(i),n=this.name.charAt(0).toUpperCase()+this.name.slice(1),Object.defineProperty(t,this.name,{configurable:!0,get:function(){return e.getInstance(this).get()},set:function(t){return e.getInstance(this).set(t)}}),t["get"+n]=function(){return e.getInstance(this).get()},t["set"+n]=function(t){return e.getInstance(this).set(t),this},t["invalidate"+n]=function(){return e.getInstance(this).invalidate(),this},t._properties=(t._properties||[]).concat([e]),null!=i&&(t._properties=t._properties.filter(function(t){return t!==i})),this.checkFunctions(t),this.checkAfterAddListener(t),e},t.prototype.override=function(t){var n,i,e,r;this.options.parent=t.options,i=t.options,e=[];for(n in i)r=i[n],"function"==typeof this.options[n]&&"function"==typeof r?e.push(this.options[n].overrided=r):void 0===this.options[n]?e.push(this.options[n]=r):e.push(void 0);return e},t.prototype.checkFunctions=function(n){var i,e,r,o;this.checkAfterAddListener(n),r=t.fn,o=[];for(e in r)i=r[e],void 0===n[e]?o.push(n[e]=i):o.push(void 0);return o},t.prototype.checkAfterAddListener=function(n){var i;if("function"==typeof n.addListener&&void 0===n.afterAddListener)return n.afterAddListener=t.optionalFn.afterAddListener,i=n.addListener,n.addListener=function(t,n){return this.addListener.overrided.call(this,t,n),this.afterAddListener(t)},n.addListener.overrided=i},t.prototype.getInstanceVarName=function(){return this.options.instanceVarName||"_"+this.name},t.prototype.isInstantiated=function(t){return null!=t[this.getInstanceVarName()]},t.prototype.getInstance=function(t){var n;return n=this.getInstanceVarName(),this.isInstantiated(t)||(t[n]=new u(this,t)),t[n]},t.prototype.getChangeEventName=function(){return this.options.changeEventName||this.name+"Changed"},t.fn={getProperty:function(t){return this._properties.find(function(n){return n.name===t})},getPropertyInstance:function(t){var n;if(n=this.getProperty(t))return n.getInstance(this)},getProperties:function(){return this._properties.slice()},getPropertyInstances:function(){return this._properties.map(function(t){return function(n){return n.getInstance(t)}}(this))},getInstantiatedProperties:function(){return this._properties.filter(function(t){return function(n){return n.isInstantiated(t)}}(this)).map(function(t){return function(n){return n.getInstance(t)}}(this))},destroyProperties:function(){return this.getInstantiatedProperties().forEach(function(t){return function(t){return t.destroy()}}()),this._properties=[],!0}},t.optionalFn={afterAddListener:function(t){return this._properties.forEach(function(n){return function(i){if(i.getChangeEventName()===t)return i.getInstance(n).get()}}(this))}},t}(),null!=h&&(h.Property=s),n=function(){function t(){}return t.elementKeywords=["extended","included"],t.prototype.tap=function(t){var n;return n=Array.prototype.slice.call(arguments),"function"==typeof t?t.apply(this,n.slice(1)):this[t].apply(this,n.slice(1)),this},t.prototype.callback=function(t){return null==this._callbacks&&(this._callbacks={}),null!=this._callbacks[t]?this._callbacks[t]:this._callbacks[t]=function(n){return function(){var i;return i=1<=arguments.length?f.call(arguments,0):[],n[t].call(n,i),null}}(this)},t.extend=function(n){var i,e,r;for(i in n)r=n[i],g.call(t.elementKeywords,i)<0&&(this[i]=r);return null!=(e=n.extended)&&e.apply(this),this},t.include=function(n){var i,e,r;for(i in n)r=n[i],g.call(t.elementKeywords,i)<0&&(this.prototype[i]=r);return null!=(e=n.included)&&e.apply(this),this},t.property=function(t,n){return new s(t,n).bind(this.prototype)},t.properties=function(t){var n,i,e;e=[];for(i in t)n=t[i],e.push(this.property(i,n));return e},t}(),null!=h&&(h.Element=n),l=function(t){function n(t,n){this.x=t,this.y=n,this.init()}return y(n,t),n.properties({x:{},y:{},links:{collection:{findStar:function(t){return this.find(function(n){return n.star2===t||n.star1===t})}}}}),n.prototype.init=function(){},n.prototype.linkTo=function(t){if(!this.links.findStar(t))return this.addLink(new this.constructor.Link(this,t))},n.prototype.addLink=function(t){return this.links.add(t),t.otherStar(this).links.add(t),t},n.prototype.dist=function(t,n){var i,e;return i=this.x-t,e=this.y-n,Math.sqrt(i*i+e*e)},n.collenctionFn={closest:function(t,n){var i,e;return i=null,e=null,this.forEach(function(r){var o;if(o=r.dist(t,n),null==i||e>o)return i=r,e=o}),i},closests:function(t,n){var i;return i=this.map(function(i){return{dist:i.dist(t,n),star:i}}),i.sort(function(t,n){return t.dist-n.dist}),this.copy(i.map(function(t){return t.star}))}},n}(n),l.Link=function(t){function n(t,n){this.star1=t,this.star2=n}return y(n,t),n.prototype.remove=function(){return this.star1.links.remove(this),this.star2.links.remove(this)},n.prototype.otherStar=function(t){return t===this.star1?this.star2:this.star1},n.prototype.getLength=function(){return this.star1.dist(this.star2.x,this.star2.y)},n.prototype.inBoundaryBox=function(t,n,i){var e,r,o,s;return null==i&&(i=0),e=Math.min(this.star1.x,this.star2.x)-i,o=Math.min(this.star1.y,this.star2.y)-i,r=Math.max(this.star1.x,this.star2.x)+i,s=Math.max(this.star1.y,this.star2.y)+i,t>=e&&t<=r&&n>=o&&n<=s},n.prototype.closeToPoint=function(t,n,i){var e,r,o,s,u,h,l,a,p,c,f;return!!this.inBoundaryBox(t,n,i)&&(e=this.star1,h=this.star2,l={x:t,y:n},a=h.x-e.x,c=h.y-e.y,Math.sqrt(a*a+c*c),o=Math.atan(c/a),p=l.x-e.x,f=l.y-e.y,s=Math.sqrt(p*p+f*f),u=Math.atan(f/p),r=o-u,Math.abs(Math.sin(r)*s)<=i)},n.prototype.intersectLink=function(t){var n,i,e,r,o,s,u,h,l,a,p,c,f,y;return u=this.star1.x,p=this.star1.y,h=this.star2.x,c=this.star2.y,l=t.star1.x,f=t.star1.y,a=t.star2.x,y=t.star2.y,i=h-u,e=c-p,r=a-l,o=y-f,n=(-e*(u-l)+i*(p-f))/(-r*e+i*o),s=(r*(p-f)-o*(u-l))/(-r*e+i*o),n>0&&n<1&&s>0&&s<1},n}(n),null!=r&&(r.Star=l),null==h&&(h={}),o=function(t){function n(t,n,i,e){this.tilesContainer=t,this.from=n,this.to=i,null==e&&(e={}),this.reset(),null!=e.validTile&&(this.validTileCallback=e.validTile)}return y(n,t),n.properties({validTileCallback:{}}),n.prototype.reset=function(){return this.queue=[],this.paths={},this.solution=null,this.started=!1},n.prototype.calcul=function(){for(;!this.solution&&(!this.started||this.queue.length);)this.step();return this.getPath()},n.prototype.step=function(){var t;return this.queue.length?(t=this.queue.pop(),this.addNextSteps(t),!0):this.started?void 0:(this.started=!0,this.addNextSteps(),!0)},n.prototype.getPath=function(){var t,n;if(this.solution){for(t=[this.solution],n=this.solution;null!=n.prev;)t.unshift(n.prev),n=n.prev;return t}},n.prototype.getPosAtTime=function(t){var n,i;if(this.solution){if(t>=this.solution.getTotalLength())return this.solution.posToTileOffset(this.solution.getExit().x,this.solution.getExit().y);for(i=this.solution;i.getStartLength()>t&&null!=i.prev;)i=i.prev;return n=(t-i.getStartLength())/i.getLength(),i.posToTileOffset(i.getEntry().x+(i.getExit().x-i.getEntry().x)*n,i.getEntry().y+(i.getExit().y-i.getEntry().y)*n)}},n.prototype.tileIsValid=function(t){return null!=this.validTileCallback?this.validTileCallback(t):!t.emulated||0!==t.tile&&!1!==t.tile},n.prototype.getTile=function(t,n){var i;return null!=this.tilesContainer.getTile?this.tilesContainer.getTile(t,n):null!=(null!=(i=this.tilesContainer[n])?i[t]:void 0)?{x:t,y:n,tile:this.tilesContainer[n][t],emulated:!0}:void 0},n.prototype.getConnectedToTile=function(t){var n,i;return null!=t.getConnected?t.getConnected():(n=[],(i=this.getTile(t.x+1,t.y))&&n.push(i),(i=this.getTile(t.x-1,t.y))&&n.push(i),(i=this.getTile(t.x,t.y+1))&&n.push(i),(i=this.getTile(t.x,t.y-1))&&n.push(i),n)},n.prototype.addNextSteps=function(t){var i,e,r,o,s,u;for(null==t&&(t=null),u=null!=t?t.nextTile:this.from,o=this.getConnectedToTile(u),s=[],i=0,e=o.length;i<e;i++)r=o[i],this.tileIsValid(r)?s.push(this.addStep(new n.Step(this,null!=t?t:null,u,r))):s.push(void 0);return s},n.prototype.tileEqual=function(t,n){return t===n||(t.emulated||n.emulated)&&t.x===n.x&&t.y===n.y},n.prototype.addStep=function(t){if(null==this.paths[t.getExit().x]&&(this.paths[t.getExit().x]={}),!(null!=this.paths[t.getExit().x][t.getExit().y]&&this.paths[t.getExit().x][t.getExit().y].getTotalLength()<=t.getTotalLength())&&(null!=this.paths[t.getExit().x][t.getExit().y]&&this.removeStep(this.paths[t.getExit().x][t.getExit().y]),this.paths[t.getExit().x][t.getExit().y]=t,this.queue.splice(this.getStepRank(t),0,t),this.tileEqual(t.nextTile,this.to)&&!(null!=this.solution&&this.solution.prev.getTotalLength()<=t.getTotalLength())))return this.solution=new n.Step(this,t,t.nextTile,null)},n.prototype.removeStep=function(t){var n;if((n=this.queue.indexOf(t))>-1)return this.queue.splice(n,1)},n.prototype.best=function(){return this.queue[this.queue.length-1]},n.prototype.getStepRank=function(t){return 0===this.queue.length?0:this._getStepRank(t.getEfficiency(),0,this.queue.length-1)},n.prototype._getStepRank=function(t,n,i){var e,r;return r=Math.floor((i-n)/2)+n,e=this.queue[r].getEfficiency(),e===t?r:e>t?r===n?n:this._getStepRank(t,n,r-1):r===i?i+1:this._getStepRank(t,r+1,i)},n}(n),o.Step=function(){function t(t,n,i,e){this.pathFinder=t,this.prev=n,this.tile=i,this.nextTile=e}return t.prototype.posToTileOffset=function(t,n){var i;return i=Math.floor(t)===this.tile.x&&Math.floor(n)===this.tile.y?this.tile:Math.floor(t)===this.nextTile.x&&Math.floor(n)===this.nextTile.y?this.nextTile:null!=this.prev&&Math.floor(t)===this.prev.tile.x&&Math.floor(n)===this.prev.tile.y?this.prev.tile:console.log("Math.floor("+t+") == "+this.tile.x,"Math.floor("+n+") == "+this.tile.y,this),{x:t,y:n,tile:i,offsetX:t-i.x,offsetY:n-i.y}},t.prototype.getExit=function(){return null==this.exit&&(null!=this.nextTile?this.exit={x:(this.tile.x+this.nextTile.x+1)/2,y:(this.tile.y+this.nextTile.y+1)/2}:this.exit={x:this.tile.x+.5,y:this.tile.y+.5}),this.exit},t.prototype.getEntry=function(){return null==this.entry&&(null!=this.prev?this.entry={x:(this.tile.x+this.prev.tile.x+1)/2,y:(this.tile.y+this.prev.tile.y+1)/2}:this.entry={x:this.tile.x+.5,y:this.tile.y+.5}),this.entry},t.prototype.getLength=function(){return null==this.length&&(this.length=null==this.nextTile||null==this.prev?.5:this.prev.tile.x===this.nextTile.x||this.prev.tile.y===this.nextTile.y?1:Math.sqrt(.5)),this.length},t.prototype.getStartLength=function(){return null==this.startLength&&(this.startLength=null!=this.prev?this.prev.getTotalLength():0),this.startLength},t.prototype.getTotalLength=function(){return null==this.totalLength&&(this.totalLength=this.getStartLength()+this.getLength()),this.totalLength},t.prototype.getEfficiency=function(){return null==this.efficiency&&(this.efficiency=1.1*-this.getRemaining()-this.getTotalLength()),this.efficiency},t.prototype.getRemaining=function(){var t,n,i,e;return null==this.remaining&&(t=this.getExit(),n={x:this.pathFinder.to.x+.5,y:this.pathFinder.to.y+.5},i=n.x-t.x,e=n.y-t.y,this.remaining=Math.sqrt(i*i+e*e)),this.remaining},t}(),null!=r&&(r.PathFinder=o),a=function(t){function n(t,n){this.x=t,this.y=n,this.init()}return y(n,t),n.prototype.init=function(){return this.children=[]},n.prototype.getRelativeTile=function(t,n){return this.container.getTile(this.x+t,this.y+n)},n.prototype.addChild=function(t){var n;return n=this.children.indexOf(t),-1===n&&this.children.push(t),t.tile=this,t},n.prototype.removeChild=function(t){var n;if(n=this.children.indexOf(t),n>-1&&this.children.splice(n,1),t.tile===this)return t.tile=null},n}(n),null!=r&&(r.Tile=a),p=function(t){function n(){this.init()}return y(n,t),n.prototype.init=function(){return this.coords={},this.tiles=[]},n.prototype.addTile=function(t){return this.tiles.push(t),null==this.coords[t.x]&&(this.coords[t.x]={}),this.coords[t.x][t.y]=t,t.container=this},n.prototype.getTile=function(t,n){var i;if(null!=(null!=(i=this.coords[t])?i[n]:void 0))return this.coords[t][n]},n.prototype.loadMatrix=function(t){var n,i,e,r,o,s;i=[];for(s in t)e=t[s],i.push(function(){var t;t=[];for(o in e)r=e[o],n={x:parseInt(o),y:parseInt(s)},"function"==typeof r?t.push(this.addTile(r(n))):(r.x=n.x,r.y=n.y,t.push(this.addTile(r)));return t}.call(this));return i},n.prototype.allTiles=function(){return this.tiles.slice()},n.prototype.clearAll=function(){var t,n,i,e;for(i=this.tiles,t=0,n=i.length;t<n;t++)e=i[t],e.container=null;return this.coords={},this.tiles=[]},n}(n),null!=r&&(r.TileContainer=p),r.Element=h.Element,"undefined"!=typeof module&&null!==module?module.exports=r:this.Parallelio=r,"undefined"!=typeof module&&null!==module?module.exports=h:this.Spark=h}).call(this);